# -*- coding: utf-8 -*-

import os, sys
import unittest
from qgis.core import QgsVectorLayer, QgsField, QgsPoint, QgsFeature, QgsGeometry
from PyQt4.QtCore import QVariant

from GBElevation.models import *

from utilities import get_qgis_app
QGIS_APP = get_qgis_app()


directory = os.path.join(os.path.dirname(__file__), 'testdata', 'NO')
interpolation = 0
# create layer
vl = QgsVectorLayer("Point?crs=epsg:27700&field=id:integer&field=height:double(20,8)&index=yes", "temporary_points", "memory")
pr = vl.dataProvider()
testQgsPoints = [
QgsPoint(337797.84,754389.19),
QgsPoint(337847.85,754576.06),
QgsPoint(337868.18,754387.36),
QgsPoint(338040.12,753937.73),
QgsPoint(338049.32,753862.54),
QgsPoint(337804.72,754026.93),
QgsPoint(337807.15,753980.72),
QgsPoint(337824.33,754095.58),
QgsPoint(337792.50,754226.34),
QgsPoint(338041.33,754263.26),
QgsPoint(337927.06,753974.65),
QgsPoint(337925.07,754266.72),
QgsPoint(337954.32,754388.37),
QgsPoint(336924.98,756754.17),
QgsPoint(338701.77,757109.63),
QgsPoint(336270.51,757592.27),
QgsPoint(337058.01,755681.47),
QgsPoint(337642.98,755680.71),
QgsPoint(336635.15,759343.05),
QgsPoint(336755.31,755437.64),
QgsPoint(337650.25,758425.33),
QgsPoint(337644.52,758432.75),
QgsPoint(337621.27,758670.79),
QgsPoint(338401.04,757842.06),
QgsPoint(338078.86,760632.25),
QgsPoint(338369.56,760204.79),
QgsPoint(338655.41,760230.23),
QgsPoint(338700.19,760138.58),
QgsPoint(338563.19,759340.32),
QgsPoint(339096.42,759600.07),
QgsPoint(339380.84,759687.25),
QgsPoint(339515.90,759728.95),
QgsPoint(349408.47,779616.53),
QgsPoint(349262.68,779694.81),
QgsPoint(349154.94,779732.25),
QgsPoint(349060.60,779848.36),
QgsPoint(350829.11,778925.96),
QgsPoint(337986.24,754320.95),
QgsPoint(338746.97,759683.08),
QgsPoint(338743.01,759686.33),
QgsPoint(338243.87,760621.14),
QgsPoint(338634.62,760254.52),
QgsPoint(338715.84,760076.11),
QgsPoint(337619.89,758657.6),
QgsPoint(337824.00,760075),
QgsPoint(337983.78,754734.45),
QgsPoint(338024.10,754693.72),
QgsPoint(337967.66,754640.23),
QgsPoint(337768.22,754116.27),
QgsPoint(337952.32,753891.45),
QgsPoint(338068.51,760636.02),
QgsPoint(337893.15,754594.94),
QgsPoint(337945.03,754588.21)
]
features = []
for testPoint in testQgsPoints:    
    # add a feature
    fet = QgsFeature()
    fet.setGeometry(QgsGeometry.fromPoint(testPoint))
    fet.setAttributes([2, None])
    features.append(fet)

pr.addFeatures(features)
        
# update layer's extent when new features have been added
# because change of extent in provider is not propagated to the layer
vl.updateExtents()
osLandformObject = OsLandform(vl, 'height', directory, 0, 10)


class TestOsLandform(unittest.TestCase):

    def setUp(self):
        """Runs before each test."""
        pass


    def test__run_10m(self):
        """Tests _run for 10m dataset"""

        testResults = [143.13,
        148.49,
        147.33,
        138.2,
        136.47,
        146.59,
        145.33,
        144.84,
        146.88,
        142.96,
        141.13,
        142.27,
        149.1,
        214.4,
        138.8,
        198.11,
        164.71,
        162.34,
        185.37,
        157.45,
        138.8,
        138.8,
        174.16,
        161.6,
        230.17,
        217.77,
        196.16,
        196.09,
        163.48,
        156.21,
        135.38,
        129.1,
        200.56,
        199.75,
        197.85,
        201,
        194.66,
        144.78,
        163.7,
        164.08,
        228.07,
        195.1,
        189.9,
        172.14,
        237.49,
        154.31,
        154.7,
        152.51,
        149.03,
        139.36,
        230.62,
        150.72,
        151.8]

        height_test = []

        osLandformObject.run()
        features = vl.getFeatures()
        for f in features:
            height_test.append(f["height"])

        for idx, height in enumerate(height_test):
            self.assertAlmostEqual( height, testResults[idx], 2) 

        

    def test__run_10m(self):
        """Tests _run for 50m dataset"""

        directory = os.path.join(os.path.dirname(__file__), 'testdata', 'NO')
        interpolation = 0
        # create layer
        layer50m = QgsVectorLayer("Point?crs=epsg:27700&field=height:double(20,8)&index=yes", "temporary_points", "memory")
        pr = layer50m.dataProvider()

        test50mPoints = [
        QgsPoint(159589.01603053300641477, 732062.92960976262111217),
        QgsPoint(361481.65120246598962694, 744803.48017276369500905),
        QgsPoint(322819.15132467984221876, 1021086.17390351905487478),
        QgsPoint(205171.28505160930217244, 695784.33601236611139029),
        QgsPoint(313254.94126565003534779, 638978.79152507288381457),
        QgsPoint(214577.2522428717056755, 699738.95419561420567334),
        QgsPoint(233485.30691486774594523, 936793.82981626165565103),
        QgsPoint(278838.06430297339102253, 657650.93026310484856367),
        QgsPoint(241920.08141231737681665, 851009.94562906888313591),
        QgsPoint(130783.17608617566293105, 857315.53806071821600199),
        QgsPoint(111501.53028526302659884, 928748.70766287483274937),
        QgsPoint(294041.30323111347388476, 843409.11633710155729204),
        QgsPoint(249809.96323728506104089, 959750.74852759763598442),
        QgsPoint(256445.5892150008585304, 929691.73431349045131356),
        QgsPoint(207313.51315559833892621, 840881.39080292731523514),
        QgsPoint(267085.01579210942145437, 638566.0162920814473182),
        QgsPoint(193330.17230099745211191, 715236.27426286356057972),
        QgsPoint(223098.39902648885617964, 712828.5502044934546575),
        QgsPoint(350395.29605736292432994, 817279.4241097355261445),
        QgsPoint(277754.07922587881330401, 920469.77208817016799003),
        QgsPoint(385945.86840075528016314, 631535.29615460243076086),
        QgsPoint(248284.07470511880819686, 881045.71064309088978916),
        QgsPoint(249542.22329496347811073, 758993.04576967912726104),
        QgsPoint(247814.25796751325833611, 936386.24572556535713375),
        QgsPoint(373996.38445887342095375, 602602.63197401026263833),
        QgsPoint(353150.59546252142172307, 585384.66271683375816792),
        QgsPoint(194462.70561614993494004, 732051.12046513624954969),
        QgsPoint(233992.47416350489947945, 669654.51386546157300472),
        QgsPoint(171154.85242653204477392, 772618.72339308506343514),
        QgsPoint(370424.81967835652176291, 844534.40660666138865054),
        QgsPoint(305410.53299443010473624, 691616.11397387483157218),
        QgsPoint(187230.33618994444259442, 895567.91960210597608238),
        QgsPoint(315921.72205137752462178, 629840.11935382708907127),
        QgsPoint(227717.05260111670941114, 854729.29698122979607433),
        QgsPoint(363048.22127239016117528, 835369.08506231661885977),
        QgsPoint(344794.80328735080547631, 626905.63508322404231876),
        QgsPoint(361920.00013011082774028, 848853.86328755645081401),
        QgsPoint(249355.57613663538359106, 597446.18192361039109528),
        QgsPoint(246089.7756136677635368, 781352.62862575566396117),
        QgsPoint(352215.63551687495782971, 856722.17847546935081482),
        QgsPoint(342581.4778176984982565, 626206.23523413017392159),
        QgsPoint(239650.86630950073595159, 917385.50682856340426952),
        QgsPoint(227977.88823289968422614, 732185.04292627016548067),
        QgsPoint(221853.83065671924850903, 792778.23387544369325042),
        QgsPoint(133864.57339954882627353, 947205.93815230019390583),
        QgsPoint(356399.06964765285374597, 768030.65508117631543428),
        QgsPoint(262365.46900653536431491, 650988.52897391351871192),
        QgsPoint(183385.58745882706716657, 857857.54213591630104929),
        QgsPoint(231227.4197616302408278, 597950.35899722343310714),
        QgsPoint(360442.32629736384842545, 622544.87548768590204418),
        QgsPoint(283775.48381107026943937, 604692.11073477938771248),
        QgsPoint(79611.52919273631414399, 819867.59814944653771818),
        QgsPoint(226550.37905103745288216, 971579.93904548673890531),
        QgsPoint(248857.2349695238226559, 587408.39989721879828721),
        QgsPoint(177492.07939758393331431, 665020.19168375642038882),
        QgsPoint(347501.7634077855036594, 710609.23468815500382334),
        QgsPoint(201204.08427444339031354, 859392.76610795792657882),
        QgsPoint(373906.40352161036571488, 799940.86618504882790148),
        QgsPoint(319499.19583557703299448, 823433.48695139226038009),
        QgsPoint(332853.05015977681614459, 634165.69684121117461473),
        QgsPoint(347158.2719789573457092, 660717.71023105946369469),
        QgsPoint(297013.8626694927806966, 653135.19754014490172267),
        QgsPoint(334021.6624791965004988, 747470.25542688556015491),
        QgsPoint(307940.08297098078764975, 695026.44658922194503248),
        QgsPoint(262490.2576999410521239, 952207.68052545050159097),
        QgsPoint(352647.67804915516171604, 664469.11131975916214287),
        QgsPoint(290601.82068881852319464, 959273.87165019451640546),
        QgsPoint(279386.70648336305748671, 602463.91974164382554591),
        QgsPoint(241690.05157520226202905, 664685.20949049724731594),
        QgsPoint(197250.14800214604474604, 838615.49303916853386909),
        QgsPoint(203121.68853593282983638, 865845.01736795355100185),
        QgsPoint(370458.14710227365139872, 806709.21429367433302104),
        QgsPoint(257878.22531864084885456, 657926.71051935234572738),
        QgsPoint(307072.53552568738814443, 926993.66667851211968809),
        QgsPoint(182331.51483212615130469, 876145.74362751154694706),
        QgsPoint(318931.9440947052789852, 859399.67332946439273655),
        QgsPoint(356307.93813893495826051, 623733.53019125934224576),
        QgsPoint(255854.8238426597090438, 747836.78153259167447686),
        QgsPoint(352789.45827637065667659, 620074.5577215125085786),
        QgsPoint(411208.55348055390641093, 849620.30387890269048512),
        QgsPoint(361163.15345080260885879, 626597.22154135257005692),
        QgsPoint(367002.34105435415403917, 862398.45210174517706037),
        QgsPoint(272194.12665999284945428, 736636.33635749435052276),
        QgsPoint(320624.47337793512269855, 700921.07206422730814666),
        QgsPoint(294107.24488852464128286, 840090.77669144328683615),
        QgsPoint(279423.6102049121982418, 947910.1757556030061096),
        QgsPoint(318912.76240305707324296, 816636.27744419593364),
        QgsPoint(323330.94585231272503734, 793091.68190327752381563),
        QgsPoint(363941.03022005048114806, 826030.40808295307215303),
        QgsPoint(268573.57379549799952656, 961851.72713485825806856),
        QgsPoint(316592.31784755975240842, 800782.64138643036130816),
        QgsPoint(223063.27278719653259031, 695585.875825768802315),
        QgsPoint(289919.52095477067632601, 732514.94476329989265651),
        QgsPoint(186877.85450365312863141, 817428.17048682959284633),
        QgsPoint(183387.09882585101877339, 762582.78946885280311108),
        QgsPoint(179060.53553749044658616, 690133.21101671480573714),
        QgsPoint(358257.25281484797596931, 588447.57661703159101307),
        QgsPoint(136168.36601516843074933, 837418.82003028003964573),
        QgsPoint(176529.13354769721627235, 681763.86966544680763036),
        QgsPoint(363006.53433575097005814, 860665.36674606963060796),
        QgsPoint(330140.02560927788726985, 855280.24956455198116601),
        QgsPoint(290749.77319133869605139, 792524.28046051948331296),
        QgsPoint(365151.47967221052385867, 618937.93584462068974972),
        QgsPoint(136748.57448847568593919, 718518.34184676443692297),
        QgsPoint(243389.33474072106764652, 598801.86625387601088732),
        QgsPoint(290247.96108941698912531, 721952.89177725370973349),
        QgsPoint(258562.36341219814494252, 898728.96882025606464595),
        QgsPoint(370794.61597146902931854, 573945.87072724825702608),
        QgsPoint(269280.97287517983932048, 824250.91471190028823912),
        QgsPoint(353434.72947427316103131, 579026.93308614380657673),
        QgsPoint(281928.69705539901042357, 763529.38263709715101868),
        QgsPoint(313438.88799137121532112, 622729.85422859247773886),
        QgsPoint(301465.47686913679353893, 822909.87537381902802736),
        QgsPoint(318058.55804464040556923, 619474.54539894277695566),
        QgsPoint(216200.45052508497610688, 818271.97346936422400177),
        QgsPoint(370586.76064237672835588, 809937.91406892868690193),
        QgsPoint(178576.06502999473013915, 778753.47830865706782788),
        QgsPoint(162777.33337606355780736, 761429.96530127944424748),
        QgsPoint(294658.80821843416197225, 943746.39467339718248695),
        QgsPoint(301365.37846338987583295, 863924.58366585744079202),
        QgsPoint(236686.91783688488067128, 894641.31239331420511007),
        QgsPoint(254564.82503963788622059, 601582.92662850813940167),
        QgsPoint(362554.18473394244210795, 835914.1525867129676044),
        QgsPoint(186236.22276394802611321, 705683.99169247865211219),
        QgsPoint(124837.85722901293775067, 911003.0703327328665182),
        QgsPoint(151496.27301932169939391, 723456.14686515368521214),
        QgsPoint(394518.69280358770629391, 861794.95590516435913742),
        QgsPoint(210108.14343437852221541, 660449.09047331335023046),
        QgsPoint(310764.13780600746395066, 922569.57258181576617062),
        QgsPoint(333884.87193448760081083, 611132.20140152226667851),
        QgsPoint(332206.09868397627724335, 946503.18141793739050627),
        QgsPoint(294566.28665740485303104, 917421.38061274669598788),
        QgsPoint(364970.44435294682625681, 858532.39388829888775945),
        QgsPoint(251739.96128175736521371, 657501.98573689325712621),
        QgsPoint(289161.89912069437559694, 734036.18113638658542186),
        QgsPoint(356861.78582424577325583, 771186.920583785045892),
        QgsPoint(291055.29682991665322334, 767127.36684327316470444),
        QgsPoint(333405.05096832616254687, 577692.59367080021183938),
        QgsPoint(278636.27561497694114223, 824855.70280784030910581),
        QgsPoint(301635.58056233206298202, 696757.77588109904900193),
        QgsPoint(207166.54636757154366933, 779489.70262753067072481),
        QgsPoint(282023.14067614870145917, 636015.40173727949149907),
        QgsPoint(296978.89766621601302177, 640569.38537873758468777),
        QgsPoint(125577.68054514628602192, 759111.27292574068997055),
        QgsPoint(180883.34459490736480802, 860302.71865356608759612),
        QgsPoint(282092.87769585091155022, 720973.11428415507543832),
        QgsPoint(300428.16082789411302656, 853968.93620489828754216),
        QgsPoint(203284.83194234583061188, 790707.26074669940862805),
        QgsPoint(281058.81383525981800631, 826599.38133909669704735),
        QgsPoint(305902.78800231247441843, 721547.18937282834667712),
        QgsPoint(301166.00007680302951485, 932096.62968064495362341),
        QgsPoint(261412.59495076138409786, 730885.9160506809130311),
        QgsPoint(186292.85510113957570866, 656681.73295840213540941),
        QgsPoint(206947.83488892021705396, 836446.72063254239037633),
        QgsPoint(138011.4858970750356093, 932378.51808535133022815),
        QgsPoint(323744.81787517230259255, 848489.83439703797921538),
        QgsPoint(232878.63938490065629594, 766875.32570970186498016),
        QgsPoint(362685.93093413533642888, 679276.46490566025022417),
        QgsPoint(310705.51793620851822197, 792446.29085833323188126),
        QgsPoint(197456.17279637610772625, 709689.37558862648438662),
        QgsPoint(312504.66794376960024238, 968532.09210457978770137),
        QgsPoint(332407.45294028322678059, 651523.27680247789248824),
        QgsPoint(240739.71178321709157899, 736134.08177356678061187),
        QgsPoint(272651.31881589739350602, 642075.47441332822199911),
        QgsPoint(226966.70879967574728653, 812289.99756174033973366),
        QgsPoint(205285.05020320377661847, 830948.58470825594849885),
        QgsPoint(242176.23956646176520735, 636594.15858970931731164),
        QgsPoint(349020.03879616636550054, 590927.88989638711791486),
        QgsPoint(222586.92228752360097133, 963746.13578722695820034),
        QgsPoint(344794.52043343719560653, 812609.90513206564355642),
        QgsPoint(266616.54868449235800654, 597196.57860919903032482),
        QgsPoint(291746.62288773315958679, 940221.06722605158574879),
        QgsPoint(321946.44066936161834747, 735969.61582958861254156),
        QgsPoint(331833.93105140811530873, 736919.79948758939281106),
        QgsPoint(323526.83081507391761988, 992442.51269202237017453),
        QgsPoint(238385.93865952495252714, 647201.84454524179454893),
        QgsPoint(195185.5039281302888412, 884537.19597786327358335),
        QgsPoint(306183.35395420348504558, 736086.68784521403722465),
        QgsPoint(170013.22478287047124468, 612191.522034693043679),
        QgsPoint(255800.68387196492403746, 699839.93655460176523775),
        QgsPoint(255294.00500773152452894, 859073.39895292511209846),
        QgsPoint(312482.33844167494680732, 606030.59206985903438181),
        QgsPoint(131664.62318150297505781, 909047.93966423510573804),
        QgsPoint(258585.29693300565122627, 796190.50627358630299568),
        QgsPoint(199440.06807339726947248, 717025.62573539349250495),
        QgsPoint(278449.70234123343834653, 954500.80318996240384877),
        QgsPoint(122310.60396239341935143, 660269.06175083003472537),
        QgsPoint(387039.62272232386749238, 855762.31138964823912829),
        QgsPoint(271666.79432465170975775, 585857.84138831880409271),
        QgsPoint(270493.42192124377470464, 676842.971534519107081),
        QgsPoint(188535.04099114373093471, 843230.32873751258011907),
        QgsPoint(260166.43082838266855106, 590970.96028813044540584),
        QgsPoint(231690.25734260198078118, 759307.63181460474152118),
        QgsPoint(270726.86817807063926011, 796670.99737956060562283),
        QgsPoint(391076.81630671280436218, 866174.76593468675855547),
        QgsPoint(251218.0484124117938336, 764455.6707851430401206),
        QgsPoint(176824.62347882706671953, 831167.85241560428403318),
        QgsPoint(381914.77601798647083342, 582256.84008369944058359),
        QgsPoint(278708.50796057982370257, 742979.96014907804783434),
        QgsPoint(284296.71685167832765728, 911605.02589200646616518),
        QgsPoint(324813.28453128109686077, 1011673.68461099220439792),
        QgsPoint(229256.26483707755687647, 869797.88630180293694139),
        QgsPoint(236823.74604904893203638, 840341.25912621372845024),
        QgsPoint(155236.2651040957425721, 822810.06088134064339101),
        QgsPoint(389870.05304010072723031, 634779.22704699647147208),
        QgsPoint(189989.23507588068605401, 628567.9678541012108326),
        QgsPoint(310792.98317469103494659, 731297.46951262641232461),
        QgsPoint(323647.51884433021768928, 742164.4476525312056765),
        QgsPoint(241758.31243935279780999, 889563.69053761940449476),
        QgsPoint(175103.6591484610689804, 746074.99288117745891213),
        QgsPoint(133786.91085148724960163, 668606.32652094773948193),
        QgsPoint(232019.38693895449978299, 862413.83658244356047362),
        QgsPoint(385919.53555244440212846, 788168.08280287613160908),
        QgsPoint(193464.83773186604958028, 760694.81353036209475249),
        QgsPoint(336920.34961291879881173, 704249.29795669892337173),
        QgsPoint(284745.93771664169616997, 806191.18258751870598644),
        QgsPoint(236535.5965015689143911, 665389.23187871836125851),
        QgsPoint(201234.50985617467085831, 629374.80702793865930289),
        QgsPoint(338339.34617586748208851, 614563.14500943408347666),
        QgsPoint(169998.01228150451788679, 772080.38839177042245865),
        QgsPoint(314108.70808317529736087, 626276.31269589730072767),
        QgsPoint(373630.61040913418401033, 838904.67835990514140576),
        QgsPoint(330600.47824652813142166, 591334.52360895753372461),
        QgsPoint(402934.88873128249542788, 633236.94409112422727048),
        QgsPoint(331472.76645376638043672, 603741.36412694002501667),
        QgsPoint(193425.73394183302298188, 749449.96709060214925557),
        QgsPoint(318147.97878691006917506, 854750.16919228772167116),
        QgsPoint(211880.10706321283942088, 681662.64602990576531738),
        QgsPoint(223273.86175379864289425, 702946.88483235135208815),
        QgsPoint(120495.71746019675629213, 664843.64542371605057269),
        QgsPoint(336170.70386425376636907, 854661.6846806569956243),
        QgsPoint(347278.74837627483066171, 846860.78188835154287517),
        QgsPoint(230749.31076984194805846, 596729.40545086958445609),
        QgsPoint(239144.74975832848576829, 797549.99185290036257356),
        QgsPoint(241825.0274623052100651, 797225.0650986295659095),
        QgsPoint(209277.32232567566097714, 690990.67432986211497337),
        QgsPoint(344970.13403849443420768, 731198.65590390039142221),
        QgsPoint(275870.88109117321437225, 680468.45355042384471744),
        QgsPoint(286345.25365469802636653, 823407.77441185596399009),
        QgsPoint(161262.74047341925324872, 608075.16706050769425929),
        QgsPoint(134854.27191116672474891, 849912.24695227679330856),
        QgsPoint(292154.92248279345221817, 624351.62178221833892167),
        QgsPoint(324633.61323119112057611, 798255.62297287827823311),
        QgsPoint(133308.09183340909658, 797085.17944426147732884),
        QgsPoint(311072.36414486094145104, 597446.33019600505940616),
        QgsPoint(370321.5024089734070003, 847040.68612451630178839),
        QgsPoint(350482.2158484494430013, 810852.87346911116037518),
        QgsPoint(401742.77294646977679804, 848164.38388169358950108),
        QgsPoint(361743.77015357074560598, 602038.78022414923179895),
        QgsPoint(127519.9216814927640371, 851000.29774441523477435),
        QgsPoint(357073.4437793685356155, 815946.36489929759409279),
        QgsPoint(147985.99907382452511229, 953215.87264763377606869),
        QgsPoint(270675.79956715600565076, 716118.02152345818467438),
        QgsPoint(342990.37072769593214616, 632503.36546951730269939),
        QgsPoint(397829.25921929493779317, 650387.9704105305718258),
        QgsPoint(198346.07268783816834912, 895028.95866389118600637),
        QgsPoint(192776.3298119863611646, 726772.98285231366753578),
        QgsPoint(225727.50422429793979973, 885071.38363864331040531),
        QgsPoint(188969.97633371120900847, 637982.54540501302108169),
        QgsPoint(216508.18132707531913184, 695391.30768696032464504),
        QgsPoint(415278.32524077006382868, 633279.41159296687692404),
        QgsPoint(75335.17271000758046284, 831018.947188132093288),
        QgsPoint(213364.25140506291063502, 677553.4494333912152797),
        QgsPoint(195984.16474629170261323, 911640.13021990086417645),
        QgsPoint(326961.97416578920092434, 946255.82843202678486705),
        QgsPoint(224311.24476325832074508, 673031.21564085735008121),
        QgsPoint(255413.23230901063652709, 769839.51239848381374031),
        QgsPoint(372462.06690215785056353, 581310.53323817974887788),
        QgsPoint(213309.2190313555765897, 689123.70260514062829316),
        QgsPoint(297774.55255399132147431, 718320.84563666500616819),
        QgsPoint(355691.61874325579265133, 1007134.9099965994246304),
        QgsPoint(397540.35331336426315829, 846619.23895460227504373),
        QgsPoint(344969.05361659696791321, 759963.58981746551580727),
        QgsPoint(393485.56163619476137683, 811499.66855525271967053),
        QgsPoint(350733.5172893603448756, 762770.20077807491179556),
        QgsPoint(221703.73866041871951893, 717430.07351827423553914),
        QgsPoint(262261.83996849448885769, 757157.57752853841520846),
        QgsPoint(352467.32708132488187402, 853528.39224689407274127),
        QgsPoint(357095.47829905932303518, 767791.13355800497811288),
        QgsPoint(183588.47742715151980519, 659598.01394124701619148),
        QgsPoint(354390.3111530524911359, 705762.10812660574447364),
        QgsPoint(213224.10794497327879071, 835759.52365457604173571),
        QgsPoint(377338.03426734037930146, 634226.9549042962025851),
        QgsPoint(308417.89333457953762263, 918979.68283070833422244),
        QgsPoint(178436.41948556911665946, 843123.89876983792055398),
        QgsPoint(347963.78546722896862775, 700668.67407155630644411),
        QgsPoint(272671.68267027533147484, 873583.53460383287165314),
        QgsPoint(318441.02749979856889695, 657986.11697715183254331),
        QgsPoint(366481.01580126537010074, 570676.86258611304219812),
        QgsPoint(329323.7205721257487312, 789295.60583859635517001),
        QgsPoint(177090.2062827228801325, 744074.6387084525777027),
        QgsPoint(187654.13739473614259623, 814501.47530596400611103),
        QgsPoint(315389.19363557494943962, 828243.59234083839692175),
        QgsPoint(354292.14928719314048067, 849276.10540195426438004),
        QgsPoint(262318.983348204405047, 651706.00280005892273039),
        QgsPoint(247593.17470507702091709, 834367.17260434047784656),
        QgsPoint(214497.63258059907821007, 743875.24047995393630117),
        QgsPoint(235884.5083157884364482, 913898.67600772436708212),
        QgsPoint(173702.84882601696881466, 668633.96146180003415793),
        QgsPoint(381229.42305717582348734, 663304.22253410029225051),
        QgsPoint(221437.59442021226277575, 813056.00323446048423648),
        QgsPoint(234090.45700605734600686, 769518.1695080497302115),
        QgsPoint(192318.4385240257543046, 683009.11140070529654622),
        QgsPoint(242997.01420633029192686, 964770.70262787840329111),
        QgsPoint(144214.36600469236145727, 720749.25002969324123114),
        QgsPoint(332409.86432008107658476, 801039.70863814221229404),
        QgsPoint(128156.06845165020786226, 914528.98122460010927171),
        QgsPoint(240490.70095822558505461, 813163.85959838412236422),
        QgsPoint(234385.55786515865474939, 643529.36634784343186766),
        QgsPoint(201323.0545982145704329, 689290.46075922064483166),
        QgsPoint(232408.34481255486025475, 647586.74218184582423419),
        QgsPoint(250295.88244237401522696, 877668.26544420642312616),
        QgsPoint(260643.43891628595883958, 675625.69667618267703801),
        QgsPoint(237874.43025765832862817, 883532.89237932744435966),
        QgsPoint(390139.26878036884590983, 848580.18484999157954007),
        QgsPoint(290927.99742868659086525, 586195.69056912430096418),
        QgsPoint(348805.060308309039101, 609818.9190693034324795),
        QgsPoint(167849.84698946692515165, 757345.85319308622274548),
        QgsPoint(307564.12330414925236255, 656834.7249142681248486),
        QgsPoint(144074.77134812215808779, 660321.71343294461257756),
        QgsPoint(238792.368750359833939, 757071.78194648621138185),
        QgsPoint(345866.79720971593633294, 603200.54608242097310722),
        QgsPoint(170838.68824263568967581, 631347.87053196749184281),
        QgsPoint(306705.01073583541437984, 712458.55598044907674193),
        QgsPoint(258717.62621112578199245, 923354.35396753333043307),
        QgsPoint(273483.61780085694044828, 887976.95278090273495764),
        QgsPoint(268572.55389641725923866, 794226.1389714329270646),
        QgsPoint(259440.49611764293513261, 647796.78310394834261388),
        QgsPoint(229044.48082952832919545, 781213.42130550101865083),
        QgsPoint(400703.39316021779086441, 634932.2061390687013045),
        QgsPoint(176827.29584574527689256, 641979.84159474517218769),
        QgsPoint(311220.16147470229770988, 627621.6903124125674367),
        QgsPoint(191228.04923684598179534, 781292.96761720185168087),
        QgsPoint(255735.42514818525523879, 797110.96007590868975967),
        QgsPoint(93740.40176623233128339, 746190.0760866116033867),
        QgsPoint(319254.90715168224414811, 741205.4599614255130291),
        QgsPoint(328838.06105872860644013, 578666.12553529033903033),
        QgsPoint(256543.5834040448826272, 736919.38274440343957394),
        QgsPoint(227759.80887398280901834, 847299.83130546286702156),
        QgsPoint(274672.31811399781145155, 791735.74346511042676866),
        QgsPoint(249175.24832323813461699, 635397.75291221216320992),
        QgsPoint(248620.44294541113777086, 792447.03125053446274251),
        QgsPoint(345850.49590922519564629, 719746.50736655306536704),
        QgsPoint(201989.89337659740704112, 670753.84639350010547787),
        QgsPoint(202450.13617592147784308, 851551.17839466198347509),
        QgsPoint(290639.20350647054146975, 831363.85422624857164919),
        QgsPoint(332832.3568985644960776, 601692.8074716436676681),
        QgsPoint(367704.53624906518962234, 572699.89860153512563556),
        QgsPoint(310942.12107427162118256, 856788.93587407085578889),
        QgsPoint(245937.1318286434689071, 746488.71566219662781805),
        QgsPoint(211550.1004347781999968, 744825.70929862861521542),
        QgsPoint(261665.70938350117648952, 593074.23022822930943221),
        QgsPoint(123695.03034958080388606, 850983.49130247801076621),
        QgsPoint(208573.96088098111795262, 757618.6952454000711441),
        QgsPoint(180569.48979352338938043, 665756.3796565622324124),
        QgsPoint(357953.82217994489474222, 782534.2623476842418313)
        ]

        features = []
        for testPoint in test50mPoints:    
            # add a feature
            fet = QgsFeature()
            fet.setGeometry(QgsGeometry.fromPoint(testPoint))
            features.append(fet)

        pr.addFeatures(features)

        # update layer's extent when new features have been added
        # because change of extent in provider is not propagated to the layer
        layer50m.updateExtents()
        osLandformObject = OsLandform(layer50m, 'height', directory, 0, 50)

        testResults = [277.105537,
        52.930397,
        1.270983,
        318.96545,
        475.242329,
        371.206455,
        43,
        105.065538,
        310.128799,
        56.543911,
        59.08309,
        144.300788,
        178.199265,
        358.318328,
        837.853667,
        252.352605,
        121.366118,
        564.717849,
        388.114211,
        203.653881,
        191.544596,
        432.128147,
        360.255228,
        234.132697,
        277.658808,
        240.947709,
        91.578002,
        141.929868,
        5.809643,
        109.149846,
        166.710882,
        89.665854,
        650.597086,
        467.174586,
        209.523999,
        156.818434,
        104.24725,
        215,
        364.034043,
        186.26884,
        209.593064,
        284.118106,
        709.948594,
        797.30282,
        36,
        199.347196,
        201.779561,
        78.24098,
        318.510434,
        91.101968,
        162.140774,
        6.597664,
        100.221861,
        518.635211,
        192.359338,
        159.149426,
        138.094547,
        70.976605,
        472.675051,
        169.016337,
        262.540545,
        273.722747,
        47.43325,
        275.388455,
        151.655678,
        234.424105,
        70.540007,
        380.341098,
        21.29581,
        355.599757,
        628.311154,
        167.115403,
        63.525486,
        554.576312,
        216.143994,
        34.651949,
        138.329396,
        562.5226,
        189.123658,
        18.83446,
        168.292536,
        18.030958,
        645.358675,
        105.931974,
        226.856034,
        219.051823,
        377.327484,
        318.537237,
        173.937786,
        1,
        622.214059,
        52.320839,
        329.146087,
        290.061768,
        196.374753,
        56.379262,
        341.111343,
        105.328899,
        287.622937,
        139.122556,
        125.598463,
        935.967321,
        84.186338,
        65.291798,
        284.424252,
        42.040778,
        151.30569,
        257.594373,
        670.086745,
        183.688144,
        339.838785,
        439.699799,
        227.979506,
        536.164936,
        685.286004,
        107.442502,
        818.472262,
        206.55654,
        211.235568,
        20.384861,
        260.003949,
        305.968362,
        252.099118,
        253.922337,
        168.938593,
        236.750239,
        79.487547,
        72.315107,
        80.592704,
        376.19574,
        78.878026,
        172.166098,
        108,
        108.007974,
        300,
        180.128712,
        357.354501,
        126.563779,
        314.357237,
        135.177721,
        225.362126,
        216.308035,
        219.258416,
        0,
        150.485661,
        62.537714,
        80.621276,
        305.688436,
        350.897562,
        106,
        295.02157,
        488.326652,
        118.338288,
        259.664394,
        69.239419,
        208.938501,
        461.52624,
        0.529298,
        437.226753,
        90.386156,
        18.484954,
        467.927497,
        632.473827,
        204.954647,
        134.133441,
        565.554641,
        20,
        160,
        7.482554,
        246.966696,
        312.997008,
        214.337615,
        94.607683,
        132.899191,
        43.460103,
        78.776414,
        174.954469,
        76.156553,
        92.602899,
        24.785054,
        2.1199,
        126.245849,
        238.978829,
        443.272311,
        65.888035,
        145.005953,
        69.893697,
        180.648898,
        218.313554,
        39,
        495.716827,
        173.96105,
        335.529616,
        290.354388,
        0,
        466.587936,
        25.411032,
        230.608106,
        505.052758,
        181.128772,
        101.473692,
        533.206794,
        177.75218,
        77.101467,
        139.678692,
        11.425344,
        41.628542,
        35.950377,
        352.524243,
        147.53646,
        100.716343,
        90.996292,
        50.636569,
        347.973553,
        90.392951,
        220.338369,
        154.590611,
        101.272478,
        278.738877,
        0.062372,
        394.567006,
        115.906433,
        227.331661,
        119.418951,
        375.128504,
        50.206762,
        136,
        126.696854,
        328.830284,
        56.932778,
        241.585923,
        228.634427,
        226.947832,
        762.896264,
        670.767589,
        179.924332,
        18.419971,
        188.214426,
        354.250415,
        299.003405,
        62.872802,
        364.708079,
        500.249641,
        181.399241,
        76.373887,
        107.348796,
        303.391425,
        40.20592,
        379.676283,
        101.398434,
        159.207653,
        143.453987,
        184.999575,
        315.065898,
        72.131893,
        67.277368,
        243.83255,
        864.855514,
        53.777017,
        562.784332,
        38.568541,
        11.296546,
        447.800896,
        26.542538,
        100.883431,
        273.427084,
        649.33758,
        238.562625,
        240.626267,
        84.6291,
        28.681889,
        39.622173,
        150.618928,
        59.993371,
        110.73371,
        546.073647,
        218.07175,
        158.306917,
        132.187946,
        90.960279,
        50.242163,
        670.810664,
        141.332874,
        0,
        612.110284,
        10,
        48.566347,
        275.90179,
        203.443609,
        429.804776,
        428.136178,
        263.27895,
        317.668479,
        126.44013,
        204.500277,
        377.120252,
        356.757847,
        249.991401,
        239.319758,
        212.242637,
        261.720388,
        621.962087,
        31.965203,
        281.828769,
        238.846247,
        385.522102,
        201.940311,
        156.841584,
        46.669975,
        263.509218,
        78.819852,
        458.962496,
        123.035981,
        525.730942,
        81.396303,
        49.263455,
        195,
        354.23606,
        401.242243,
        109.006161,
        505.174861,
        418.945477,
        244.829397,
        225.83699,
        437.084448,
        0,
        289.504498,
        276.30946,
        275.537199,
        110.915576,
        222.7899,
        225.787841,
        50.343023,
        698.81493,
        4.166891,
        69.109199,
        182.083732,
        639.714338,
        292.993252,
        402.285131,
        108.179767,
        819.971287,
        0,
        107.649787,
        247.943793,
        463.704421,
        426.21809,
        238.907247,
        232.813587,
        459.354288,
        0.000976,
        303.380111,
        18.47104,
        102.808079,
        86.758903,
        368.951722]

        height_test = []

        osLandformObject.run()
        features = layer50m.getFeatures()
        for f in features:
            height_test.append(f["height"])

        for idx, height in enumerate(height_test):
            self.assertAlmostEqual( height, testResults[idx], 2) 




